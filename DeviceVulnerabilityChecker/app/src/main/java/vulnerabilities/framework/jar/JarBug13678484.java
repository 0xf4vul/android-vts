package vulnerabilities.framework.jar;

import android.content.Context;
import android.util.Log;

import java.util.ArrayList;

import java.security.cert.Certificate;
import java.security.cert.X509Certificate;

import vulnerabilities.VulnerabilityTest;

// https://android.googlesource.com/platform/libcore/+/cb11b9fff2a1af8bb4fcad18986003a7f59189c6 //Tests
// https://android.googlesource.com/platform/libcore/+/2bc5e811a817a8c667bca4318ae98582b0ee6dc6 //Fix
// http://bluebox.com/technical/android-fake-id-vulnerability/

public class JarBug13678484 implements VulnerabilityTest {

    @Override
    public String getName() {
        return "JarBug13678484";
    }

    @Override
    public boolean isVulnerable(Context context) throws Exception {
        ArrayList<String> validatedCertChain = new ArrayList<String>();

        Certificate[] certs = JarFileHelper.getSignedJarCerts("/data/local/tmp/test.jar", true);
        for(Certificate c: certs)
          validatedCertChain.add(((X509Certificate)c).getSubjectDN().toString());

        ArrayList<String> unvalidatedCertChain = new ArrayList<String>();

        Certificate[] certsfalse = JarFileHelper.getSignedJarCerts("/data/local/tmp/test.jar", false);
        for(Certificate c: certsfalse)
            unvalidatedCertChain.add(((X509Certificate)c).getSubjectDN().toString());

        if(validatedCertChain.equals(unvalidatedCertChain))
            Log.d("CERTCHAIN", "SUCCESSS!!!");
        else
            Log.d("CERTCHAIN", "FAILED!!!!!!");

        return false;
    }

}
